# QR Scanner System Documentation - Delivery Driver App

## Overview

The QR scanner system enables delivery drivers to confirm both pickup and delivery actions using secure QR codes. This document outlines the technical implementation, process flow, and usage guidelines.

## Table of Contents

1. [QR Scanner Implementation](#qr-scanner-implementation)
2. [Backend Data Structure](#backend-data-structure)
3. [Process Flow](#process-flow)
4. [Security Considerations](#security-considerations)
5. [Usage Instructions](#usage-instructions)
6. [Code Examples](#code-examples)

## QR Scanner Implementation

The app uses a QR code scanner in two key contexts:
- For drivers to confirm **pickup** of an order from the warehouse
- For drivers to confirm **delivery** of an order to the customer

### App Components

1. **QrScannerService**: Service class that encapsulates scanner functionality:
   - Manages camera and QR scanning
   - Handles scanning state (active/paused)
   - Provides utilities (flash toggle, camera flip)

2. **QrScannerScreen**: Dedicated UI screen that:
   - Displays camera feed with scanning overlay
   - Animates scan line for user feedback
   - Shows success/failure screens after scanning
   - Supports different modes (pickup/delivery)

3. **ViewModel Integration**: The `DeliveryOrdersViewModel` contains:
   - Methods to verify QR codes with backend
   - State management for scanning process
   - Error handling for failed scans

## Backend Data Structure

In Firebase Firestore, each delivery order document contains:

```
orders/{orderId}:
  - id: "order_xxx"
  - customerId: "customer_xxx"
  - customerName: "Jane Smith"
  - driverId: "driver_xxx"
  - status: "pending" | "pickedUp" | "delivered"
  - qrCodePickup: "unique-pickup-code-xxx"
  - qrCodeDelivery: "unique-delivery-code-xxx"
  - assignedTime: Timestamp
  - pickupTime: Timestamp (null until picked up)
  - deliveryTime: Timestamp (null until delivered)
  - items: [Array of OrderItems]
```

## Process Flow

### 1. Order Creation & Assignment

1. **Admin System**:
   - Creates order with customer details
   - Generates unique QR codes for pickup and delivery
   - Assigns order to specific driver
   - Stores order in Firestore

2. **Driver Notification**:
   - Driver receives push notification
   - App fetches and displays order in "Pending" tab

### 2. Pickup Process

1. **Warehouse Arrival**:
   - Driver selects order from "Pending" tab
   - Taps "Scan QR for Pickup" button

2. **QR Scanning**:
   - QR Scanner activates camera
   - Driver scans QR code on package/manifest

3. **Verification**:
   - Backend verifies QR code matches stored pickup code
   - Updates order status to "pickedUp"
   - Records timestamp for pickup

4. **Confirmation**:
   - App shows success screen
   - Order moves to "In Progress" tab
   - Warehouse system receives confirmation

### 3. Delivery Process

1. **Customer Arrival**:
   - Driver selects order from "In Progress" tab
   - Optionally uses navigation to customer location
   - Taps "Scan QR for Delivery" button

2. **QR Scanning**:
   - Driver scans QR code at delivery location

3. **Verification**:
   - Backend verifies QR code matches delivery code
   - Confirms order was previously picked up
   - Updates status to "delivered"
   - Records timestamp for delivery

4. **Confirmation**:
   - App shows delivery confirmation
   - Order moves to "Completed" tab
   - Customer and admin receive notifications

## QR Code Distribution

1. **Pickup QR Code**:
   - Generated by warehouse system
   - Printed on package or manifest
   - Stored at warehouse location

2. **Delivery QR Code Options**:
   - Sent to customer via email/SMS
   - Included with delivery package
   - Generated in customer's app
   - Displayed at delivery location

## Security Considerations

1. **Authentication**: All requests require authenticated user
2. **Authorization**: Verifies driver is assigned to the order
3. **Sequence Validation**: Delivery requires prior pickup
4. **Unique Codes**: Each order has unique pickup and delivery codes
5. **Server Timestamps**: All timestamps generated server-side
6. **Error Handling**: Robust failure handling with clear user feedback

## Usage Instructions

### For Pickup:
```
Home Screen → Pending Tab → Select Order → 
Order Details → "Scan QR for Pickup" → 
Point Camera at Warehouse QR Code → Confirmation
```

### For Delivery:
```
Home Screen → In Progress Tab → Select Order → 
Order Details → "Scan QR for Delivery" → 
Point Camera at Customer's QR Code → Confirmation
```

### Quick Scan (from any screen):
```
Home Screen → Floating Action Button (QR Icon) → 
Point Camera at Any QR Code → App determines action based on code
```

## Code Examples

### QR Scanner Service

```dart
class QrScannerService {
  QRViewController? _controller;
  bool _isScanning = false;
  
  void initializeScanner(QRViewController controller, Function(String) onQrCodeScanned) {
    _controller = controller;
    _isScanning = true;
    
    _controller?.scannedDataStream.listen((scanData) {
      if (_isScanning && scanData.code != null) {
        _handleScannedCode(scanData.code!);
      }
    });
  }
  
  void _handleScannedCode(String code) {
    _isScanning = false;
    HapticFeedback.mediumImpact();
    if (_onQrCodeScanned != null) {
      _onQrCodeScanned!(code);
    }
  }
  
  // Other methods: toggleFlash(), pauseScanning(), resumeScanning()
}
```

### Backend Verification Logic

```dart
Future<bool> confirmPickup(String orderId, String qrCode) async {
  try {
    // Get the order and verify it exists
    final DocumentSnapshot doc = await _ordersCollection.doc(orderId).get();
    if (!doc.exists) return false;
    
    final Map<String, dynamic> data = doc.data() as Map<String, dynamic>;
    
    // Security checks
    if (data['driverId'] != getCurrentUserId()) {
      throw Exception('Order does not belong to the current driver');
    }
    
    // Verify QR code matches
    if (data['qrCodePickup'] != qrCode) return false;
    
    // Update status and timestamp
    await _ordersCollection.doc(orderId).update({
      'status': 'pickedUp',
      'pickupTime': FieldValue.serverTimestamp(),
    });
    
    return true;
  } catch (e) {
    print('Error confirming pickup: $e');
    return false;
  }
}
```

---

This document provides a comprehensive overview of the QR scanner system in the Delivery Driver App, covering both technical implementation and user workflows.
